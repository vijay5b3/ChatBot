<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>SSE Broadcast Test</h1>
    <button onclick="testBroadcast()">Send Test Message</button>
    <div id="log" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace;"></div>
    
    <script>
        const logEl = document.getElementById('log');
        
        function log(msg) {
            logEl.innerHTML += msg + '<br>';
            console.log(msg);
        }
        
        // Connect to SSE
        const es = new EventSource('/events');
        es.onopen = () => log('SSE: Connected');
        es.onmessage = (ev) => {
            log('SSE Message: ' + ev.data);
        };
        es.onerror = (e) => log('SSE Error: ' + e);
        
        async function testBroadcast() {
            log('Sending test message to API...');
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Source': 'web-ui'
                    },
                    body: JSON.stringify({ 
                        messages: [
                            { role: 'user', content: 'What is binary search?' }
                        ] 
                    })
                });
                const data = await res.json();
                log('API Response: ' + JSON.stringify(data).substring(0, 200));
            } catch (err) {
                log('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
